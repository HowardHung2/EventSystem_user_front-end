<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»å‹•æ™‚æ•¸ç®¡ç†ç³»çµ± - Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

<div id="app" class="container" style="max-width: 600px;">
    
    <div v-if="isLoading" class="loading-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <h2 class="text-center mb-4">æ´»å‹•æ™‚æ•¸ç³»çµ± Demo</h2>

    <div class="card p-4" v-if="!isLoggedIn">
        <h4 class="mb-3">ğŸ‘‹ æ­¡è¿ä½¿ç”¨</h4>
        <div class="mb-3">
            <label class="form-label">æ¨¡æ“¬ LINE User ID</label>
            <input type="text" class="form-control" v-model="loginForm.lineUserId" placeholder="ä¾‹å¦‚: USER_001">
        </div>
        
        <ul class="nav nav-tabs mb-3">
            <li class="nav-item">
                <a class="nav-link" :class="{active: loginMode === 'login'}" href="#" @click.prevent="loginMode = 'login'">ç™»å…¥</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" :class="{active: loginMode === 'register'}" href="#" @click.prevent="loginMode = 'register'">æ–°ç”¨æˆ¶è¨»å†Š</a>
            </li>
        </ul>

        <div v-if="loginMode === 'register'">
            <div class="mb-3">
                <label class="form-label">å§“å</label>
                <input type="text" class="form-control" v-model="loginForm.name" placeholder="ç‹å°æ˜">
            </div>
            <div class="mb-3">
                <label class="form-label">éƒ¨é–€/å–®ä½</label>
                <input type="text" class="form-control" v-model="loginForm.department" placeholder="è³‡è¨Šè™•">
            </div>
            <div class="mb-3">
                <label class="form-label">Gov ID (é¸å¡«)</label>
                <input type="text" class="form-control" v-model="loginForm.govId">
            </div>
        </div>

        <button class="btn btn-primary w-100" @click="handleAuth">
            {{ loginMode === 'login' ? 'ç™»å…¥ç³»çµ±' : 'è¨»å†Šä¸¦ç™»å…¥' }}
        </button>
    </div>

    <div v-else>
        <div class="card text-white bg-dark mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title">{{ currentUser.name || loginForm.lineUserId }}</h5>
                        <p class="card-text small">{{ currentUser.department }}</p>
                    </div>
                    <div class="text-end">
                        <h2 class="mb-0">{{ dashboard.totalHours }} <span class="fs-6">å°æ™‚</span></h2>
                        <small>å·²æ ¸å®šæ™‚æ•¸</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-3 text-end">
            <button class="btn btn-sm btn-outline-secondary" @click="refreshData">ğŸ”„ é‡æ–°æ•´ç†</button>
            <button class="btn btn-sm btn-outline-danger ms-2" @click="logout">ç™»å‡º</button>
        </div>

        <h5 class="mb-3">ğŸ“… å¾…è™•ç†æ´»å‹•</h5>
        <div v-if="activities.length === 0" class="alert alert-info">
            ç›®å‰æ²’æœ‰å¾…è™•ç†çš„æ´»å‹•ã€‚
        </div>

        <div class="card mb-3" v-for="act in activities" :key="act.ActivityId">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <h5 class="card-title">{{ act.Title }}</h5>
                    <span class="badge bg-warning text-dark">{{ act.CertifiedHours }} å°æ™‚</span>
                </div>
                <p class="card-text text-muted mb-2">
                    <small>ğŸ•’ {{ formatDate(act.ActivityStartDate) }} {{ act.StartTime }} ~ {{ act.EndTime }}</small><br>
                    <small>ğŸ“ {{ act.Location }}</small>
                </small>
                <p class="card-text">{{ act.Description }}</p>
                
                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-success flex-grow-1" @click="rsvp(act.ActivityId, 'REGISTERED')">æˆ‘è¦åƒåŠ </button>
                    <button class="btn btn-outline-secondary flex-grow-1" @click="rsvp(act.ActivityId, 'LEAVE')">è«‹å‡</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, reactive } = Vue;

    // ğŸ”¥ è¨­å®šå€ï¼šè«‹å°‡é€™è£¡æ›æˆä½ çš„ GAS Web App URL
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbzGbAAEvC0QXDHdmDi5b1FjLzTOwu24gUCAYARVHcxF-vlibUFjv0zN_3OJsN9Z6R5T/exec'; 

    createApp({
        setup() {
            const isLoading = ref(false);
            const isLoggedIn = ref(false);
            const loginMode = ref('login'); // 'login' or 'register'
            
            // è¡¨å–®è³‡æ–™
            const loginForm = reactive({
                lineUserId: '',
                name: '',
                department: '',
                govId: ''
            });

            // ä½¿ç”¨è€…è³‡æ–™
            const currentUser = reactive({});
            const dashboard = reactive({ totalHours: 0 });
            const activities = ref([]);

            // é€šç”¨ API å‘¼å«
            const callApi = async (action, payload = {}) => {
                if (!GAS_API_URL.includes("script.google.com")) {
                    alert("è«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®šæ­£ç¢ºçš„ GAS_API_URLï¼");
                    return null;
                }
                
                isLoading.value = true;
                try {
                    const bodyData = {
                        action: action,
                        lineUserId: loginForm.lineUserId,
                        payload: payload
                    };

                    const res = await fetch(GAS_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain' },
                        body: JSON.stringify(bodyData)
                    });
                    
                    const json = await res.json();
                    
                    if (json.status === 'error') {
                        // ç‰¹ä¾‹è™•ç†ï¼šå¦‚æœç™»å…¥æ™‚ User Not Foundï¼Œä¸è·³ alertï¼Œå› ç‚ºè¦å¼•å°å»è¨»å†Š
                        if (json.code === 'USER_NOT_FOUND' && action === 'getUserDashboard') {
                            throw new Error('USER_NOT_FOUND');
                        }
                        alert('éŒ¯èª¤: ' + json.message);
                        return null;
                    }
                    return json.data;
                } catch (err) {
                    console.error(err);
                    if (err.message !== 'USER_NOT_FOUND') {
                        alert('é€£ç·šå¤±æ•—æˆ–ç³»çµ±éŒ¯èª¤');
                    }
                    return null; // å›å‚³ null ä»£è¡¨å¤±æ•—
                } finally {
                    isLoading.value = false;
                }
            };

            // ç™»å…¥æˆ–è¨»å†Šæµç¨‹
            const handleAuth = async () => {
                if (!loginForm.lineUserId) return alert("è«‹è¼¸å…¥ ID");

                if (loginMode.value === 'register') {
                    // è¨»å†Šæµç¨‹
                    const res = await callApi('registerUser', {
                        lineUserId: loginForm.lineUserId,
                        name: loginForm.name,
                        department: loginForm.department,
                        govId: loginForm.govId
                    });
                    if (res) {
                        alert("è¨»å†ŠæˆåŠŸï¼");
                        loginMode.value = 'login'; // åˆ‡å›ç™»å…¥æ¨¡å¼
                        performLogin();
                    }
                } else {
                    // ç™»å…¥æµç¨‹
                    performLogin();
                }
            };

            const performLogin = async () => {
                // æˆ‘å€‘å˜—è©¦å‘¼å« Dashboard ä¾†é©—è­‰ä½¿ç”¨è€…æ˜¯å¦å­˜åœ¨
                const data = await callApi('getUserDashboard');
                if (data) {
                    isLoggedIn.value = true;
                    dashboard.totalHours = data.totalHours;
                    // ä¿å­˜ç°¡æ˜“è³‡è¨Š (å¯¦éš›å°ˆæ¡ˆæ‡‰ç”±å¾Œç«¯å›å‚³ user profile)
                    currentUser.department = loginForm.department || 'è¼‰å…¥ä¸­...';
                    
                    // ç™»å…¥æˆåŠŸå¾Œï¼Œé †ä¾¿æŠ“å–æ´»å‹•åˆ—è¡¨
                    fetchActivities();
                } else {
                    alert("æ‰¾ä¸åˆ°ä½¿ç”¨è€…ï¼Œè«‹å…ˆåˆ‡æ›åˆ°ã€Œæ–°ç”¨æˆ¶è¨»å†Šã€");
                }
            };

            const fetchActivities = async () => {
                const data = await callApi('getPendingActivities');
                if (data) {
                    activities.value = data;
                }
            };

            const refreshData = () => {
                performLogin(); // é‡æ–°æŠ“å–è³‡æ–™
            };

            const logout = () => {
                isLoggedIn.value = false;
                activities.value = [];
                loginForm.lineUserId = '';
            };

            const rsvp = async (activityId, status) => {
                const reason = status === 'LEAVE' ? prompt("è«‹è¼¸å…¥è«‹å‡ç†ç”±ï¼š") : "";
                if (status === 'LEAVE' && !reason) return; // å–æ¶ˆè¼¸å…¥

                const res = await callApi('rsvpActivity', {
                    activityId: activityId,
                    status: status,
                    reason: reason
                });

                if (res) {
                    alert(status === 'REGISTERED' ? 'å ±åæˆåŠŸï¼' : 'è«‹å‡ç”³è«‹å·²é€å‡º');
                    fetchActivities(); // æ›´æ–°åˆ—è¡¨ (è©²æ´»å‹•æ‡‰è©²æœƒæ¶ˆå¤±)
                }
            };
            
            // æ—¥æœŸæ ¼å¼åŒ–å°å·¥å…·
            const formatDate = (dateStr) => {
                if (!dateStr) return '';
                return dateStr.split('T')[0];
            };

            return {
                isLoading, isLoggedIn, loginMode, loginForm,
                currentUser, dashboard, activities,
                handleAuth, logout, refreshData, rsvp, formatDate
            };
        }
    }).mount('#app');
</script>

</body>
</html>