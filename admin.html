<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»å‹•ç³»çµ± - å¾Œå°ç®¡ç†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body { background-color: #f0f2f5; }
        .sidebar { min-height: 100vh; background: #343a40; color: white; }
        .nav-link { color: rgba(255,255,255,.75); cursor: pointer; }
        .nav-link:hover, .nav-link.active { color: white; background: rgba(255,255,255,0.1); }
        .card { box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: none; }
        .status-badge { font-size: 0.8em; padding: 5px 8px; border-radius: 10px; }
    </style>
</head>
<body>

<div id="app" class="d-flex">
    
    <div v-if="isLoading" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;display:flex;justify-content:center;align-items:center;color:white;">
        <div class="spinner-border me-2"></div> è™•ç†ä¸­...
    </div>

    <div v-if="!isAdminLoggedIn" class="container d-flex justify-content-center align-items-center" style="height: 100vh;">
        <div class="card p-5" style="width: 400px;">
            <h3 class="text-center mb-4">å¾Œå°ç®¡ç†ç™»å…¥</h3>
            <div class="mb-3">
                <label class="form-label">ç®¡ç†å“¡ Line User ID</label>
                <input type="text" class="form-control" v-model="adminId" placeholder="è«‹è¼¸å…¥ Admin çš„ ID">
                <div class="form-text">è«‹ç¢ºä¿æ­¤ ID åœ¨ Sheet ä¸­çš„ Role ç‚º ADMIN</div>
            </div>
            <button class="btn btn-dark w-100" @click="adminLogin">ç™»å…¥å¾Œå°</button>
        </div>
    </div>

    <div v-else class="d-flex w-100">
        <div class="sidebar p-3" style="width: 250px;">
            <h4 class="mb-4 ps-2">æ´»å‹•ç®¡ç†å¾Œå°</h4>
            <ul class="nav flex-column">
                <li class="nav-item mb-2">
                    <a class="nav-link" :class="{active: currentView === 'list'}" @click="currentView = 'list'">ğŸ“‹ æ´»å‹•åˆ—è¡¨</a>
                </li>
                <li class="nav-item mb-2">
                    <a class="nav-link" :class="{active: currentView === 'create' && !isEditing}" @click="resetCreate">â• æ–°å¢æ´»å‹•</a>
                </li>
                <li class="nav-item mt-auto">
                    <a class="nav-link text-danger" @click="logout">ğŸšª ç™»å‡º</a>
                </li>
            </ul>
        </div>

        <div class="flex-grow-1 p-4" style="height: 100vh; overflow-y: auto;">
            
            <div v-if="currentView === 'list'">
                <h3 class="mb-4">æ‰€æœ‰æ´»å‹•æ¦‚æ³</h3>
                <div class="row">
                    <div class="col-md-12">
                        <div class="card p-3">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>æ´»å‹•åç¨±</th>
                                        <th>æ—¥æœŸ</th>
                                        <th>æ ¸å®šæ™‚æ•¸</th>
                                        <th>å ±å / è«‹å‡ / å‡ºå¸­</th>
                                        <th>ç‹€æ…‹</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="act in activities" :key="act.ActivityId">
                                        <td class="fw-bold">{{ act.Title }}</td>
                                        <td>{{ formatDate(act.ActivityStartDate) }}</td>
                                        <td>{{ act.CertifiedHours }} hr</td>
                                        <td>
                                            <span class="badge bg-primary">{{ act.stats.registered }}</span> / 
                                            <span class="badge bg-warning text-dark">{{ act.stats.leave }}</span> / 
                                            <span class="badge bg-success">{{ act.stats.attended }}</span>
                                        </td>
                                        <td>
                                            <span class="badge" :class="act.Status === 'OPEN' ? 'bg-success' : 'bg-secondary'">{{ act.Status }}</span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-secondary me-1" @click="openEdit(act)">ç·¨è¼¯</button>
                                            <button class="btn btn-sm btn-outline-primary" @click="openVerifyModal(act)">äººå“¡æ ¸éŠ·</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div v-if="activities.length === 0" class="text-center text-muted py-4">ç›®å‰æ²’æœ‰æ´»å‹•</div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'create'">
                <h3 class="mb-4">{{ isEditing ? 'ç·¨è¼¯æ´»å‹•' : 'å»ºç«‹æ–°æ´»å‹•' }}</h3>
                <div class="card p-4" style="max-width: 800px;">
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label class="form-label">æ´»å‹•åç¨±</label>
                            <input type="text" class="form-control" v-model="newAct.title">
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label text-danger fw-bold">å¿…å‚™åƒèˆ‡è€… ({{ newAct.mustParticipants.length }} äºº)</label>
                            <div class="card p-2" style="height: 200px; overflow-y: auto; background: #fff;">
                                <div class="form-check" v-for="user in userList" :key="user.userId">
                                    <input class="form-check-input" type="checkbox" :value="user.userId" v-model="newAct.mustParticipants">
                                    <label class="form-check-label">
                                        {{ user.name }} <small class="text-muted">({{ user.department }})</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label text-primary fw-bold">é æœŸåƒèˆ‡è€… ({{ newAct.expectedParticipants.length }} äºº)</label>
                            <div class="card p-2" style="height: 200px; overflow-y: auto; background: #fff;">
                                <div class="form-check" v-for="user in userList" :key="'exp_' + user.userId">
                                    <input class="form-check-input" type="checkbox" :value="user.userId" v-model="newAct.expectedParticipants">
                                    <label class="form-check-label">
                                        {{ user.name }} <small class="text-muted">({{ user.department }})</small>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">é–‹å§‹æ—¥æœŸ</label>
                            <input type="date" class="form-control" v-model="newAct.activityStartDate">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">çµæŸæ—¥æœŸ</label>
                            <input type="date" class="form-control" v-model="newAct.activityEndDate">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">é–‹å§‹æ™‚é–“</label>
                            <input type="time" class="form-control" v-model="newAct.startTime">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">çµæŸæ™‚é–“</label>
                            <input type="time" class="form-control" v-model="newAct.endTime">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">æ ¸ç™¼æ™‚æ•¸ (å°æ™‚)</label>
                            <input type="number" class="form-control" v-model="newAct.certifiedHours">
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">åœ°é»</label>
                            <input type="text" class="form-control" v-model="newAct.location">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">æ´»å‹•èªªæ˜</label>
                            <textarea class="form-control" rows="3" v-model="newAct.description"></textarea>
                        </div>
                    </div>
                    <div class="mt-4 text-end">
                        <button class="btn btn-secondary me-2" @click="currentView = 'list'">å–æ¶ˆ</button>
                        <button class="btn btn-primary" @click="isEditing ? submitUpdate() : submitActivity()">
                            {{ isEditing ? 'å„²å­˜è®Šæ›´' : 'å»ºç«‹æ´»å‹•' }}
                        </button>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'verify'">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>äººå“¡ç°½åˆ°ç®¡ç†: {{ selectedActivity.Title }}</h3>
                    <button class="btn btn-secondary" @click="currentView = 'list'">è¿”å›åˆ—è¡¨</button>
                </div>
                
                <div class="card p-3">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>å§“å</th>
                                <th>éƒ¨é–€</th>
                                <th>ç›®å‰ç‹€æ…‹</th>
                                <th>ç†ç”± (è‹¥è«‹å‡)</th>
                                <th>æ“ä½œ (æ ¸å®šæ™‚æ•¸: {{ selectedActivity.CertifiedHours }})</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="p in participants" :key="p.recordId">
                                <td>{{ p.userName }}</td>
                                <td>{{ p.department }}</td>
                                <td>
                                    <span class="badge" :class="getStatusColor(p.status)">{{ p.status }}</span>
                                </td>
                                <td>{{ p.reason }}</td>
                                <td>
                                    <button v-if="p.status !== 'ATTENDED'" class="btn btn-sm btn-success me-1" @click="verifyUser(p, 'ATTENDED')">ç¢ºèªå‡ºå¸­</button>
                                    <button v-if="p.status !== 'ABSENT'" class="btn btn-sm btn-outline-danger" @click="verifyUser(p, 'ABSENT')">ç¼ºå¸­/æœªåˆ°</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div v-if="participants.length === 0" class="text-center py-3">ç›®å‰ç„¡äººå ±å</div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    const { createApp, ref, reactive } = Vue;

    // ğŸ”¥ è¨­å®šå€ï¼šè«‹ç¢ºèªé€™æ˜¯æ‚¨çš„ GAS URL
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbzGbAAEvC0QXDHdmDi5b1FjLzTOwu24gUCAYARVHcxF-vlibUFjv0zN_3OJsN9Z6R5T/exec'; 

    createApp({
        setup() {
            const isLoading = ref(false);
            const isAdminLoggedIn = ref(false);
            const adminId = ref('');
            const currentView = ref('list'); 
            
            // ğŸ”¥ ä¿®æ­£ï¼šè£œä¸Šç¼ºå¤±çš„ç·¨è¼¯ç‹€æ…‹è®Šæ•¸
            const isEditing = ref(false);
            const editingId = ref('');

            const activities = ref([]);
            const participants = ref([]);
            const selectedActivity = ref({});
            const userList = ref([]);

            const newAct = reactive({
                title: '', activityStartDate: '', activityEndDate: '',
                startTime: '09:00', endTime: '12:00',
                certifiedHours: 3, location: '', description: '',
                mustParticipants: [], 
                expectedParticipants: []
            });

            const callApi = async (action, payload = {}) => {
                if (!GAS_API_URL.startsWith("https")) return alert("ç¶²å€è¨­å®šéŒ¯èª¤");
                isLoading.value = true;
                try {
                    const res = await fetch(GAS_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ 
                            action, 
                            lineUserId: adminId.value, 
                            payload 
                        })
                    });
                    const json = await res.json();
                    if (json.status === 'error') {
                        alert('éŒ¯èª¤: ' + json.message);
                        return null;
                    }
                    return json.data;
                } catch (e) {
                    alert('é€£ç·šå¤±æ•—: ' + e.message);
                    return null;
                } finally {
                    isLoading.value = false;
                }
            };

            const adminLogin = async () => {
                if (!adminId.value) return alert("è«‹è¼¸å…¥ ID");
                
                const res = await callApi('getAllActivitiesAdmin');
                if (res) {
                    isAdminLoggedIn.value = true;
                    activities.value = res;
                    
                    const users = await callApi('getAllUsers');
                    if (users) {
                        userList.value = users;
                    }
                }
            };

            const submitActivity = async () => {
                const res = await callApi('createActivity', newAct);
                
                if (res) {
                    alert("æ´»å‹•å»ºç«‹æˆåŠŸï¼");
                    currentView.value = 'list';
                    
                    // é‡ç½®è¡¨å–®
                    resetForm();
                    const list = await callApi('getAllActivitiesAdmin');
                    if(list) activities.value = list;
                }
            };

            const openVerifyModal = async (act) => {
                selectedActivity.value = act;
                const res = await callApi('getActivityRecords', { activityId: act.ActivityId });
                if (res) {
                    participants.value = res;
                    currentView.value = 'verify';
                }
            };

            const verifyUser = async (record, status) => {
                if(!confirm(`ç¢ºå®šå°‡ ${record.userName} æ¨™è¨˜ç‚º ${status} å—?`)) return;

                const now = new Date();
                const timeStr = now.getHours() + ":" + now.getMinutes();

                const res = await callApi('verifyAttendance', {
                    recordId: record.recordId,
                    status: status,
                    checkInTime: timeStr,
                    checkOutTime: timeStr,
                    certifiedHours: selectedActivity.value.CertifiedHours
                });

                if (res) {
                    record.status = status;
                }
            };

            // ğŸ”¥ ä¿®æ­£ï¼šè£œä¸Šç¼ºå¤±çš„ openEdit å‡½å¼
            const openEdit = (act) => {
                isEditing.value = true;
                editingId.value = act.ActivityId;
                
                // å¡«å……è¡¨å–®è³‡æ–™
                let must = [];
                let exp = [];
                try { must = JSON.parse(act.MustParticipants || '[]'); } catch(e){}
                try { exp = JSON.parse(act.ExpectedParticipants || '[]'); } catch(e){}

                Object.assign(newAct, {
                    title: act.Title,
                    activityStartDate: act.ActivityStartDate,
                    activityEndDate: act.ActivityEndDate,
                    startTime: act.StartTime,
                    endTime: act.EndTime,
                    certifiedHours: act.CertifiedHours,
                    location: act.Location,
                    description: act.Description,
                    mustParticipants: must,
                    expectedParticipants: exp
                });

                currentView.value = 'create';
            };

            // ğŸ”¥ ä¿®æ­£ï¼šè£œä¸Šç¼ºå¤±çš„ submitUpdate å‡½å¼
            const submitUpdate = async () => {
                if(!confirm("ç¢ºå®šè¦å„²å­˜è®Šæ›´å—ï¼Ÿ")) return;

                const payload = {
                    activityId: editingId.value,
                    ...newAct
                };

                const res = await callApi('updateActivity', payload);
                
                if (res) {
                    alert("ä¿®æ”¹æˆåŠŸï¼");
                    currentView.value = 'list';
                    isEditing.value = false;
                    
                    resetForm();
                    const list = await callApi('getAllActivitiesAdmin');
                    if(list) activities.value = list;
                }
            };

            // ğŸ”¥ ä¿®æ­£ï¼šè£œä¸Šç¼ºå¤±çš„ resetCreate å‡½å¼
            const resetCreate = () => {
                isEditing.value = false;
                editingId.value = '';
                currentView.value = 'create';
                resetForm();
            };

            const resetForm = () => {
                Object.keys(newAct).forEach(k => {
                    if(Array.isArray(newAct[k])) newAct[k] = [];
                    else newAct[k] = '';
                });
                newAct.startTime = '09:00';
                newAct.endTime = '12:00';
                newAct.certifiedHours = 3;
            };

            const logout = () => {
                isAdminLoggedIn.value = false;
                adminId.value = '';
                activities.value = [];
            };

            const formatDate = (d) => d ? d.split('T')[0] : '';
            const getStatusColor = (s) => {
                if(s === 'REGISTERED') return 'bg-primary';
                if(s === 'LEAVE') return 'bg-warning text-dark';
                if(s === 'ATTENDED') return 'bg-success';
                if(s === 'ABSENT') return 'bg-danger';
                return 'bg-secondary';
            };

            return {
                isLoading, isAdminLoggedIn, adminId, currentView,
                activities, participants, selectedActivity, newAct,
                // ğŸ”¥ ä¿®æ­£ï¼šé€™äº›è®Šæ•¸åŸæœ¬æ²’æœ‰ return å‡ºä¾†ï¼Œå°è‡´ HTML è®€ä¸åˆ°
                userList, isEditing, 
                adminLogin, submitActivity, openVerifyModal, verifyUser, logout,
                formatDate, getStatusColor,
                // ğŸ”¥ ä¿®æ­£ï¼šé€™ä¸‰å€‹å‡½å¼ä¹Ÿå¿…é ˆ return
                submitUpdate, resetCreate, openEdit
            };
        }
    }).mount('#app');
</script>
</body>
</html>